<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hur l√§nge orkar Daniel? ‚õ∑Ô∏è</title>
  <style>
    :root{
      --rexel-blue:#003A8F;
      --rexel-blue-2:#0B4DB8;
      --bg:#F4F7FB;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5A6B85;
      --border:#D9E2F1;
      --accent:#FFC928;
      --danger:#C62828;
      --ok:#1B7F4B;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -100px, rgba(0,58,143,.18), transparent 60%),
                  linear-gradient(180deg, #ffffff 0%, var(--bg) 60%);
      color:var(--text);
    }

    .topbar{
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
      padding:14px 16px;
      position: sticky;
      top:0;
      z-index:10;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-size:15px;
      margin:0;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .pill{
      font-size:12px;
      padding:4px 8px;
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      opacity:.95;
      white-space:nowrap;
    }

    .container{
      max-width:980px;
      margin:18px auto 40px;
      padding:0 16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
    }
    @media (max-width: 860px){ .container{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:18px 18px 10px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .icon{
      width:52px;
      height:52px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background: rgba(0,58,143,.08);
      border:1px solid rgba(0,58,143,.18);
      flex:0 0 auto;
    }
    .titleblock h2{
      margin:0;
      font-size:20px;
      line-height:1.2;
    }
    .titleblock p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.45;
      font-size:14px;
    }
    .card-body{padding:0 18px 18px}

    .cta-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-weight:700;
      letter-spacing:.2px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
    }
    .btn-ghost{
      background:#fff;
      color:var(--rexel-blue);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn-accent{
      background: linear-gradient(90deg, #ffda4b, var(--accent));
      color:#1e1e1e;
    }

    .form{
      display:grid;
      gap:12px;
      margin-top:14px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:700;
      letter-spacing:.15px;
    }
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-size:15px;
      background:#fff;
    }
    textarea{ resize: vertical; min-height: 44px; }
    input:focus, textarea:focus{
      border-color: rgba(0,58,143,.55);
      box-shadow: 0 0 0 4px rgba(0,58,143,.10);
    }

    .grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .grid-2{grid-template-columns:1fr} }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin-top:4px;
    }

    .alert{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid;
      display:none;
      font-size:14px;
      line-height:1.35;
    }
    .alert.ok{
      display:block;
      background: rgba(27,127,75,.08);
      border-color: rgba(27,127,75,.25);
      color: var(--ok);
    }
    .alert.err{
      display:block;
      background: rgba(198,40,40,.08);
      border-color: rgba(198,40,40,.25);
      color: var(--danger);
    }

    .rules{
      padding:18px;
      border-top:1px dashed var(--border);
      background: linear-gradient(180deg, rgba(0,58,143,.03), transparent);
    }
    .rules h3{margin:0 0 8px; font-size:16px}
    .rules ul{margin:0; padding-left:18px; color:var(--text)}
    .rules li{margin:8px 0; color:var(--muted); line-height:1.45}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(11,18,32,.55);
      display:none;
      padding:16px;
      z-index:50;
    }
    .modal{
      max-width:720px;
      margin: 40px auto;
      background:#fff;
      border-radius:18px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.2);
    }
    .modal-head{
      padding:14px 16px;
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal-head h3{margin:0; font-size:15px}
    .modal-body{padding:16px}
    .close{
      background: rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .modal-backdrop.show{display:block}

    .footer{
      max-width:980px;
      margin:0 auto;
      padding:0 16px 30px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-bottom-width:2px;
      border-radius:8px;
      background:#fff;
      color:var(--text);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="pill">Rexel-bl√•tt tema</div>
        <h1>Daniel vs Dalarna ‚Äì tidstips</h1>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-ghost" id="openRulesBtn" type="button">üìú Regler</button>
        <button class="btn btn-ghost" id="openAdminBtn" type="button" style="display:none;">üîí Admin</button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- LEFT: Hero -->
    <section class="card">
      <div class="card-header">
        <div class="icon" aria-hidden="true" title="Vasalopps-ikon (Daniel edition)">
          <svg width="34" height="34" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 52c8 6 36 6 44 0" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M18 44l12-18 8 6 12-10" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="30" cy="18" r="6" stroke="rgba(0,58,143,.9)" stroke-width="4"/>
            <path d="M28 24l-8 14" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M34 26l8 10" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="titleblock">
          <h2 id="heroTitle">‚õ∑Ô∏è Hur l√§nge orkar Daniel?</h2>
          <p>
            Daniel har laddat med bl√•b√§rssoppa, tejpade stavar och ett sj√§lvf√∂rtroende som pendlar mellan
            ‚Äújag √§r od√∂dlig‚Äù och ‚Äúvarf√∂r finns uppf√∂rsbackar‚Äù.
            Hur l√§nge orkar en k√∂ttbulle p√• skidor egentligen?
            <br><br>
            Din uppgift: gissa <b>hur l√§nge</b> han h√•ller ut.
          </p>

          <div class="cta-row">
            <button class="btn btn-accent" id="scrollToFormBtn" type="button">üéØ Gissa tid</button>
            <button class="btn btn-primary" id="shareBtn" type="button">üì≤ Dela</button>
          </div>

          <p class="hint">
            Tips: skriv tiden som <span class="kbd">HH:MM:SS</span> (t.ex. <span class="kbd">07:12:00</span>).
            Gratis att delta. 1 gissning per person.
          </p>
        </div>
      </div>

      <div class="rules">
        <h3>Snabbregler</h3>
        <ul>
          <li><b>Gratis</b>. Du gissar en g√•ng.</li>
          <li>Vinnare = den som √§r <b>n√§rmast</b> Daniels officiella tid.</li>
          <li>Om Daniel bryter/g√•r in i v√§ggen: vi anv√§nder tiden vid <b>sista officiella kontroll</b>.</li>
        </ul>
      </div>
    </section>

    <!-- RIGHT: Form -->
    <section class="card" id="guessCard">
      <div class="card-header">
        <div class="titleblock">
          <h2>üßæ L√§gg din gissning</h2>
          <p>Fyll i namn, mobilnummer, din gissade tid ‚Äì och g√§rna en rolig kommentar üòÑ</p>
        </div>
      </div>

      <div class="card-body">
        <div id="gameStatusBox" style="border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;">
          <div style="font-weight:900;">‚è≥ Status</div>
          <div id="gameStatusText" style="margin-top:6px; font-weight:800;">Laddar‚Ä¶</div>
          <div class="hint" id="gameStatusHint" style="margin-top:6px;"></div>
        </div>

        <form class="form" id="guessForm" autocomplete="on" novalidate>
          <div class="grid-2">
            <div>
              <label for="name">Namn</label>
              <input id="name" name="name" type="text" placeholder="F√∂rnamn Efternamn" required />
            </div>
            <div>
              <label for="phone">Mobilnummer</label>
              <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="07XXXXXXXX" required />
              <div class="hint">Anv√§nds bara f√∂r att kontakta vinnaren & stoppa dubbla gissningar.</div>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="timeGuess">Gissad tid (HH:MM:SS)</label>
              <input id="timeGuess" name="timeGuess" type="text" inputmode="numeric" placeholder="07:12:00" required />
              <div class="hint">Exakt format: HH:MM:SS</div>
            </div>
            <div>
              <label for="comment">Rolig kommentar (valfritt)</label>
              <input id="comment" name="comment" type="text" maxlength="120"
                     placeholder="Typ: ‚ÄòDaniel drivs av ren vilja och kexchoklad‚Ä¶‚Äô" />
              <div class="hint">Max 120 tecken. H√•ll det sn√§llt üòä</div>
            </div>
          </div>

          <div>
            <label for="consent">Godk√§nnande</label>
            <div style="display:flex; align-items:flex-start; gap:10px; margin-top:8px;">
              <input id="consent" name="consent" type="checkbox" style="width:auto; transform: scale(1.2);" required />
              <span style="font-size:14px; color:var(--muted); line-height:1.35;">
                Jag godk√§nner reglerna och att vi sparar mina uppgifter f√∂r att kunna kontakta vinnaren.
              </span>
            </div>
          </div>

          <button class="btn btn-primary" type="submit" id="submitBtn">‚úÖ Skicka min gissning</button>

          <div class="alert ok" id="okAlert"></div>
          <div class="alert err" id="errAlert"></div>

          <div class="hint" style="margin-top:10px;">
            Gissningar skickas till Google Sheets via Apps Script (live leaderboard).
          </div>
        </form>
      </div>
    </section>

    <!-- LIVE DASHBOARD -->
    <section class="card" id="liveCard">
      <div class="card-header">
        <div class="titleblock">
          <h2>üìä Nuvarande st√§llning</h2>
          <p>Topp 10 just nu. Klicka <b>Ut√∂ka</b> f√∂r att se alla deltagare.</p>
          <p class="hint" id="liveMeta">Laddar‚Ä¶</p>

          <div class="cta-row" style="margin-top:10px;">
            <button class="btn btn-primary" type="button" id="refreshLiveBtn">üîÑ Uppdatera</button>
            <button class="btn btn-ghost" type="button" id="toggleAllBtn">‚ûï Ut√∂ka</button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div id="top10Box" style="display:grid; gap:10px;"></div>
        <div id="allBox" style="display:none; margin-top:14px;"></div>
      </div>
    </section>

    <!-- ADMIN PANEL (hidden) -->
    <section class="card" id="adminCard" style="display:none;">
      <div class="card-header">
        <div class="titleblock">
          <h2>üîí Admin</h2>
          <p>H√§r kan du s√§tta start/bettingstopp/official tid (kr√§ver st√∂d i Apps Script).</p>
        </div>
      </div>

      <div class="card-body">
        <div class="form" style="margin-top:0;">
          <div class="grid-2">
            <div>
              <label for="startTime">Starttid (ISO)</label>
              <input id="startTime" type="text" placeholder="2026-03-01 08:00:00" />
              <div class="hint">Format: YYYY-MM-DD HH:MM:SS</div>
            </div>
            <div>
              <label for="betCloseTime">Bettingstopp (ISO)</label>
              <input id="betCloseTime" type="text" placeholder="2026-03-01 07:55:00" />
              <div class="hint">Format: YYYY-MM-DD HH:MM:SS</div>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="officialTime">Officiell tid (HH:MM:SS)</label>
              <input id="officialTime" type="text" placeholder="07:18:42" />
              <div class="hint">S√§tt n√§r resultatet √§r klart.</div>
            </div>
            <div>
              <label for="adminNote">Notering (valfritt)</label>
              <input id="adminNote" type="text" placeholder="M√•l / br√∂t vid kontroll X" />
            </div>
          </div>

          <div class="cta-row" style="margin-top:8px;">
            <button class="btn btn-primary" type="button" id="saveSettingsBtn">üíæ Spara tider</button>
            <button class="btn btn-ghost" type="button" id="refreshAdminBtn">üîÑ H√§mta nuvarande</button>
          </div>

          <div class="cta-row" style="margin-top:8px;">
            <button class="btn btn-primary" type="button" id="calcWinnerBtn">üèÜ R√§kna vinnare</button>
            <button class="btn btn-ghost" type="button" id="exportBtn">‚¨áÔ∏è Exportera gissningar (CSV)</button>
          </div>

          <div class="alert ok" id="adminOk" style="display:none;"></div>
          <div class="alert err" id="adminErr" style="display:none;"></div>

          <div class="card" style="margin-top:12px; border-radius:14px;">
            <div class="card-body" style="padding:14px;">
              <div style="font-weight:800; margin-bottom:6px;">Resultat</div>
              <div id="winnerBox" style="color:var(--muted); line-height:1.5;">Inget utr√§knat √§nnu.</div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Admin visas n√§r du √∂ppnar sidan med <span class="kbd">?admin=1</span> i URL.
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    <div><b>Integritet:</b> Namn + telefon anv√§nds bara f√∂r att kontakta vinnaren. Kommentarer ska h√•llas sn√§lla. Allt rensas efter t√§vlingen.</div>
  </div>

  <!-- Rules Modal -->
  <div class="modal-backdrop" id="rulesModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <div class="modal-head">
        <h3 id="rulesTitle">üìú Spelregler ‚Äì ‚ÄúHur l√§nge orkar Daniel?‚Äù</h3>
        <button class="close" id="closeRulesBtn" type="button">St√§ng ‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0;color:var(--muted);line-height:1.6">
          Enkelt, tydligt och utan kr√•ngel.
        </p>

        <h4 style="margin:16px 0 8px;">1) S√• h√§r g√∂r du</h4>
        <ol style="margin:0; padding-left:18px; color:var(--muted); line-height:1.6">
          <li>Gissa Daniels tid i <b>HH:MM:SS</b>.</li>
          <li>Fyll i namn + telefonnummer (+ valfri kommentar).</li>
          <li>Skicka in ‚Äì klart.</li>
        </ol>

        <h4 style="margin:16px 0 8px;">2) En gissning</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Gratis att delta. Du f√•r l√§mna <b>en (1)</b> gissning per mobilnummer.
        </p>

        <h4 style="margin:16px 0 8px;">3) Hur r√§knas tiden?</h4>
        <ul style="margin:0; padding-left:18px; color:var(--muted); line-height:1.6">
          <li>G√•r Daniel i m√•l ‚Üí <b>officiell m√•ltid</b> g√§ller.</li>
          <li>Bryter Daniel ‚Üí <b>tiden vid sista officiella kontrollen</b> g√§ller.</li>
          <li>Vi anv√§nder arrang√∂rens officiella tider/resultat.</li>
        </ul>

        <h4 style="margin:16px 0 8px;">4) Vinnare</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Den som gissar <b>n√§rmast</b> vinner priset. Vid exakt lika: f√∂rst inskickad gissning vinner.
        </p>

        <h4 style="margin:16px 0 8px;">5) Personuppgifter</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Namn och telefon anv√§nds f√∂r att administrera t√§vlingen och kontakta vinnaren.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ===================== CONFIG =====================
    const LIVE_ENDPOINT = "https://script.google.com/macros/s/AKfycbxL30c5qw0KL_4QyNkyyjoN2lhZlonT0kHJ0oIX7a_UxstK0-osjvHOQsSpD0dOpb2r/exec";

    // ===================== HELPERS =====================
    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str || "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function normalizePhone(phoneRaw){
      return (phoneRaw || "").replace(/\s+/g, "").replace(/-/g, "");
    }

    function parseHHMMSS(s){
      const m = /^(\d{1,2}):([0-5]\d):([0-5]\d)$/.exec((s||"").trim());
      if(!m) return null;
      const h = Number(m[1]), mm = Number(m[2]), ss = Number(m[3]);
      if(h > 30) return null;
      return h*3600 + mm*60 + ss;
    }

    function formatHHMMSS(seconds){
      const h = Math.floor(seconds/3600);
      const m = Math.floor((seconds%3600)/60);
      const s = seconds%60;
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    function parseStartDateTime(str){
      if(!str) return null;
      const s = String(str).trim().replace(" ", "T");
      const d = new Date(s);
      if(Number.isNaN(d.getTime())) return null;
      return d;
    }

    function formatClock(sec){
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    function fmtDiff(absSeconds){
      const m = Math.floor(absSeconds/60);
      const s = absSeconds%60;
      const pad = (n)=> String(n).padStart(2,"0");
      if(m >= 60){
        const h = Math.floor(m/60);
        const mm = m%60;
        return `${pad(h)}:${pad(mm)}:${pad(s)}`;
      }
      return `${pad(m)}:${pad(s)}`;
    }

    // ===================== MODAL + BUTTONS =====================
    const rulesModal = $("rulesModal");
    $("openRulesBtn").addEventListener("click", ()=> rulesModal.classList.add("show"));
    $("closeRulesBtn").addEventListener("click", ()=> rulesModal.classList.remove("show"));
    rulesModal.addEventListener("click", (e)=>{ if(e.target === rulesModal) rulesModal.classList.remove("show"); });

    $("scrollToFormBtn").addEventListener("click", ()=>{
      $("guessCard").scrollIntoView({behavior:"smooth", block:"start"});
      setTimeout(()=> $("timeGuess").focus(), 400);
    });

    $("shareBtn").addEventListener("click", async ()=>{
      const text = "‚õ∑Ô∏è Hur l√§nge orkar Daniel? Gissa tiden (gratis) ‚Äì n√§rmast vinner pris!";
      try{
        if(navigator.share){
          await navigator.share({ title: document.title, text, url: location.href });
        }else{
          await navigator.clipboard.writeText(location.href);
          alert("L√§nken kopierad!");
        }
      }catch(_){}
    });

    // ===================== STATUS (BETTING/START) =====================
    let phaseInterval = null;

    function lockBetting(msg){
      ["name","phone","timeGuess","comment","consent"].forEach(id => {
        const el = $(id);
        if(el) el.disabled = true;
      });
      const btn = $("submitBtn");
      if(btn){
        btn.disabled = true;
        btn.textContent = "‚õî Betting st√§ngd";
      }
      setStatus(msg || "Betting √§r st√§ngd.", "");
    }

    function unlockBetting(){
      ["name","phone","timeGuess","comment","consent"].forEach(id => {
        const el = $(id);
        if(el) el.disabled = false;
      });
      const btn = $("submitBtn");
      if(btn){
        btn.disabled = false;
        btn.textContent = "‚úÖ Skicka min gissning";
      }
    }

    function setStatus(text, hint){
      const t = $("gameStatusText");
      const h = $("gameStatusHint");
      if(t) t.textContent = text;
      if(h) h.textContent = hint || "";
    }

    function startPhaseClock({startDate, closeDate, official_time}){
      if(phaseInterval) clearInterval(phaseInterval);

      const tick = ()=>{
        const now = new Date();

        if(official_time){
          lockBetting("üèÅ Loppet √§r avgjort ‚Äì betting st√§ngd.");
          setStatus("üèÅ Slutresultat", "Leaderboard visar slutst√§llning.");
          return;
        }

        if(!startDate){
          unlockBetting();
          setStatus("üü¢ √ñppet f√∂r gissningar", "Starttid √§r inte satt √§nnu.");
          return;
        }

        const effectiveClose = closeDate || startDate;

        if(now < effectiveClose){
          const secLeft = Math.max(0, Math.floor((effectiveClose - now)/1000));
          unlockBetting();
          setStatus("üü¢ Betting √∂ppen", `Betting st√§nger om ${formatClock(secLeft)}.`);
          return;
        }

        if(now >= effectiveClose && now < startDate){
          const secToStart = Math.max(0, Math.floor((startDate - now)/1000));
          lockBetting("‚õî Betting st√§ngd");
          setStatus("‚õî Betting st√§ngd", `Start om ${formatClock(secToStart)}.`);
          return;
        }

        const elapsed = Math.max(0, Math.floor((now - startDate)/1000));
        lockBetting("üöÄ Spelet har startat");
        setStatus("üöÄ Spelet p√•g√•r", `Daniel har (minst) h√•llit p√• i ${formatClock(elapsed)}.`);
      };

      tick();
      phaseInterval = setInterval(tick, 1000);
    }

    // ===================== LIVE DASHBOARD =====================
    let showAll = false;

    function renderRows(rows, targetEl, limit=null){
      const list = (limit ? rows.slice(0, limit) : rows);

      if(list.length === 0){
        targetEl.innerHTML = `<div class="hint">Inga gissningar √§n.</div>`;
        return;
      }

      targetEl.innerHTML = list.map((r, idx)=>`
        <div style="border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; justify-content:space-between; gap:10px;">
          <div style="min-width:0;">
            <div style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              #${idx+1} ${escapeHtml(r.name)}
            </div>
            <div class="hint">Gissning: <b>${escapeHtml(r.guess_time)}</b></div>
            ${r.comment ? `<div class="hint">üí¨ ‚Äú${escapeHtml(r.comment)}‚Äù</div>` : ``}
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;">${fmtDiff(r.absDiff)}</div>
            <div class="hint">${r.absDiff} sek</div>
          </div>
        </div>
      `).join("");
    }

    async function fetchLiveData(){
      const res = await fetch(LIVE_ENDPOINT, { cache: "no-store" });
      if(!res.ok) throw new Error("Kunde inte h√§mta live-data");
      return await res.json();
    }

    async function updateDashboard(){
      const meta = $("liveMeta");
      const top10Box = $("top10Box");
      const allBox = $("allBox");

      try{
        meta.textContent = "Laddar‚Ä¶";
        const data = await fetchLiveData();

        // Status / tider
        const startDate = parseStartDateTime(data.start_time || null);
        const closeDate = parseStartDateTime(data.bet_close_time || null);
        startPhaseClock({ startDate, closeDate, official_time: data.official_time || null });

        const officialStr = data.official_time; // "HH:MM:SS" or null
        const officialSec = officialStr ? parseHHMMSS(officialStr) : null;

        const guesses = data.guesses || [];

        // Om ingen officiell tid: visa bara gissningar i inskick-ordning (eller tid)
        if(officialSec === null){
          meta.innerHTML = `Officiell tid: <b>inte satt √§nnu</b> ‚Ä¢ Deltagare: <b>${guesses.length}</b>`;
          const rows = guesses.map(g => ({
            name: g.name || "Ok√§nd",
            guess_time: g.guess_time || (typeof g.guess_seconds === "number" ? formatHHMMSS(g.guess_seconds) : ""),
            comment: g.comment || "",
            absDiff: 0,
            created_at: g.created_at || ""
          }));
          renderRows(rows, top10Box, 10);
          allBox.style.display = showAll ? "block" : "none";
          if(showAll) renderRows(rows, allBox, null);
          return;
        }

        // Ranking mot officiell tid
        const ranked = guesses.map(g=>{
          const guessSec = (typeof g.guess_seconds === "number") ? g.guess_seconds : parseHHMMSS(g.guess_time);
          const diff = (typeof guessSec === "number") ? Math.abs(guessSec - officialSec) : 999999;
          return {
            name: g.name || "Ok√§nd",
            guess_time: g.guess_time || (typeof guessSec === "number" ? formatHHMMSS(guessSec) : ""),
            comment: g.comment || "",
            absDiff: diff,
            created_at: g.created_at || ""
          };
        }).sort((a,b)=>{
          if(a.absDiff !== b.absDiff) return a.absDiff - b.absDiff;
          return (Date.parse(a.created_at)||0) - (Date.parse(b.created_at)||0);
        });

        meta.innerHTML = `Officiell tid: <b>${officialStr}</b> ‚Ä¢ Deltagare: <b>${ranked.length}</b>`;
        renderRows(ranked, top10Box, 10);

        allBox.style.display = showAll ? "block" : "none";
        if(showAll) renderRows(ranked, allBox, null);
      }catch(e){
        meta.textContent = "Kunde inte ladda st√§llningen (n√§tfel eller endpoint).";
        top10Box.innerHTML = `<div class="hint">${escapeHtml(String(e.message || e))}</div>`;
      }
    }

    $("refreshLiveBtn").addEventListener("click", updateDashboard);
    $("toggleAllBtn").addEventListener("click", ()=>{
      showAll = !showAll;
      $("toggleAllBtn").textContent = showAll ? "‚ûñ Minimera" : "‚ûï Ut√∂ka";
      updateDashboard();
    });

    // ===================== SUBMIT (SEND TO SHEETS) =====================
    function showOk(msg){
      $("okAlert").textContent = msg;
      $("errAlert").textContent = "";
      $("errAlert").style.display = "none";
      $("okAlert").style.display = "block";
    }
    function showErr(msg){
      $("errAlert").textContent = msg;
      $("okAlert").textContent = "";
      $("okAlert").style.display = "none";
      $("errAlert").style.display = "block";
    }
    function lockFormSubmitted(){
      ["name","phone","timeGuess","comment","consent"].forEach(id => {
        const el = $(id);
        if(el) el.disabled = true;
      });
      $("submitBtn").disabled = true;
      $("submitBtn").textContent = "üîí Gissning inskickad";
    }

    $("guessForm").addEventListener("submit", async (e)=>{
      e.preventDefault();

      const name = ($("name").value || "").trim();
      const phone = normalizePhone($("phone").value);
      const timeStr = ($("timeGuess").value || "").trim();
      const comment = ($("comment").value || "").trim();
      const consent = $("consent").checked;

      if(!name) return showErr("Skriv ditt namn.");
      if(!phone || phone.length < 9) return showErr("Skriv ett giltigt mobilnummer.");
      if(!consent) return showErr("Du m√•ste godk√§nna reglerna f√∂r att delta.");
      if(comment.length > 120) return showErr("Kommentaren f√•r max vara 120 tecken.");

      const seconds = parseHHMMSS(timeStr);
      if(seconds === null) return showErr("Tiden m√•ste vara i formatet HH:MM:SS (t.ex. 07:12:00).");

      const entry = {
        name,
        phone,
        comment,
        guess_seconds: seconds,
        guess_time: formatHHMMSS(seconds),
        created_at: new Date().toISOString()
      };

      try{
        const res = await fetch(LIVE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "submit_guess", ...entry })
        });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Kunde inte spara gissningen.");

        showOk(`Klart! ‚úÖ Din gissning √§r skickad: ${entry.guess_time}.`);
        lockFormSubmitted();
        updateDashboard();
      }catch(err){
        showErr("Kunde inte skicka gissningen. Kontrollera endpoint / Apps Script och f√∂rs√∂k igen.");
      }
    });

    // ===================== ADMIN VISIBILITY + ACTIONS =====================
    (function adminInit(){
      const adminBtn = $("openAdminBtn");
      const adminCard = $("adminCard");
      if(!adminBtn || !adminCard) return;

      const params = new URLSearchParams(location.search);
      const isAdmin = params.get("admin") === "1";
      if(isAdmin){
        adminBtn.style.display = "inline-flex";
        adminCard.style.display = "block";
      }

      adminBtn.addEventListener("click", ()=>{
        const hidden = (adminCard.style.display === "none" || !adminCard.style.display);
        adminCard.style.display = hidden ? "block" : "none";
        if(hidden) adminCard.scrollIntoView({behavior:"smooth", block:"start"});
      });
    })();

    function adminOk(msg){
      $("adminOk").textContent = msg;
      $("adminErr").style.display = "none";
      $("adminOk").style.display = "block";
    }
    function adminErr(msg){
      $("adminErr").textContent = msg;
      $("adminOk").style.display = "none";
      $("adminErr").style.display = "block";
    }

    $("refreshAdminBtn")?.addEventListener("click", async ()=>{
      try{
        const data = await fetchLiveData();
        $("startTime").value = data.start_time || "";
        $("betCloseTime").value = data.bet_close_time || "";
        $("officialTime").value = data.official_time || "";
        $("adminNote").value = data.note || "";
        adminOk("H√§mtat ‚úÖ");
      }catch(e){
        adminErr("Kunde inte h√§mta admin-data fr√•n endpoint.");
      }
    });

    $("saveSettingsBtn")?.addEventListener("click", async ()=>{
      const payload = {
        action: "set_settings",
        start_time: ($("startTime").value || "").trim(),
        bet_close_time: ($("betCloseTime").value || "").trim(),
        official_time: ($("officialTime").value || "").trim(),
        note: ($("adminNote").value || "").trim(),
      };

      try{
        const res = await fetch(LIVE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Misslyckades.");
        adminOk("Sparat ‚úÖ");
        updateDashboard();
      }catch(e){
        adminErr("Kunde inte spara (Apps Script saknar kanske st√∂d f√∂r set_settings).");
      }
    });

    $("calcWinnerBtn")?.addEventListener("click", async ()=>{
      try{
        const data = await fetchLiveData();
        const officialStr = data.official_time;
        const officialSec = officialStr ? parseHHMMSS(officialStr) : null;
        if(officialSec === null) return adminErr("S√§tt officiell tid f√∂rst.");

        const guesses = data.guesses || [];
        if(!guesses.length) return adminErr("Inga gissningar.");

        let best = null;
        for(const g of guesses){
          const guessSec = (typeof g.guess_seconds === "number") ? g.guess_seconds : parseHHMMSS(g.guess_time);
          if(typeof guessSec !== "number") continue;
          const abs = Math.abs(guessSec - officialSec);
          const created = Date.parse(g.created_at || "") || Number.MAX_SAFE_INTEGER;

          const entry = { ...g, guessSec, abs, created };
          if(!best) best = entry;
          else if(entry.abs < best.abs) best = entry;
          else if(entry.abs === best.abs && entry.created < best.created) best = entry;
        }
        if(!best) return adminErr("Kunde inte r√§kna.");

        const mask = (p)=>{
          const ph = normalizePhone(p);
          if(ph.length <= 4) return ph;
          return ph.slice(0,3) + "****" + ph.slice(-2);
        };

        $("winnerBox").innerHTML = `
          <div><b>Officiell tid:</b> ${escapeHtml(officialStr)}</div>
          <div style="margin-top:8px;"><b>Vinnare:</b> ${escapeHtml(best.name || "Ok√§nd")} (${escapeHtml(mask(best.phone || ""))})</div>
          <div><b>Gissning:</b> ${escapeHtml(best.guess_time || formatHHMMSS(best.guessSec))}</div>
          <div><b>Avvikelse:</b> ${best.abs} sek</div>
          ${best.comment ? `<div class="hint" style="margin-top:6px;">üí¨ ‚Äú${escapeHtml(best.comment)}‚Äù</div>` : ``}
        `;
        adminOk("Vinnare utr√§knad ‚úÖ");
      }catch(e){
        adminErr("Kunde inte r√§kna (endpoint-fel).");
      }
    });

    $("exportBtn")?.addEventListener("click", async ()=>{
      try{
        const data = await fetchLiveData();
        const guesses = data.guesses || [];
        if(!guesses.length) return adminErr("Inga gissningar att exportera.");

        const header = ["name","phone","guess_time","guess_seconds","comment","created_at"];
        const rows = [header.join(",")];

        for(const g of guesses){
          const row = [
            (g.name||"").replaceAll('"','""'),
            (g.phone||"").replaceAll('"','""'),
            (g.guess_time||"").replaceAll('"','""'),
            String(g.guess_seconds ?? ""),
            (g.comment||"").replaceAll('"','""'),
            (g.created_at||"").replaceAll('"','""')
          ].map(v => `"${v}"`);
          rows.push(row.join(","));
        }

        const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "gissningar.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        adminOk("CSV exporterat ‚úÖ");
      }catch(e){
        adminErr("Kunde inte exportera (endpoint-fel).");
      }
    });

    // Init
    updateDashboard();
  </script>
</body>
</html>
