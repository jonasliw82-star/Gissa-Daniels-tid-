<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hur l√§nge orkar Daniel? ‚õ∑Ô∏è</title>
  <style>
    :root{
      --rexel-blue:#003A8F;
      --rexel-blue-2:#0B4DB8;
      --bg:#F4F7FB;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#5A6B85;
      --border:#D9E2F1;
      --accent:#FFC928;
      --danger:#C62828;
      --ok:#1B7F4B;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -100px, rgba(0,58,143,.18), transparent 60%),
                  linear-gradient(180deg, #ffffff 0%, var(--bg) 60%);
      color:var(--text);
    }
    .topbar{
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
      padding:14px 16px;
      position: sticky;
      top:0;
      z-index:10;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-size:15px;
      margin:0;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .pill{
      font-size:12px;
      padding:4px 8px;
      border:1px solid rgba(255,255,255,.25);
      border-radius:999px;
      opacity:.95;
      white-space:nowrap;
    }

    .container{
      max-width:980px;
      margin:18px auto 40px;
      padding:0 16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
    }
    @media (max-width: 860px){ .container{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:18px 18px 10px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .icon{
      width:52px;
      height:52px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background: rgba(0,58,143,.08);
      border:1px solid rgba(0,58,143,.18);
      flex:0 0 auto;
    }
    .titleblock h2{
      margin:0;
      font-size:20px;
      line-height:1.2;
    }
    .titleblock p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.45;
      font-size:14px;
    }
    .card-body{padding:0 18px 18px}

    .cta-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-weight:700;
      letter-spacing:.2px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
    }
    .btn-ghost{
      background:#fff;
      color:var(--rexel-blue);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn-accent{
      background: linear-gradient(90deg, #ffda4b, var(--accent));
      color:#1e1e1e;
    }
    .form{
      display:grid;
      gap:12px;
      margin-top:14px;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      font-weight:700;
      letter-spacing:.15px;
    }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      font-size:15px;
      background:#fff;
    }
    input:focus{
      border-color: rgba(0,58,143,.55);
      box-shadow: 0 0 0 4px rgba(0,58,143,.10);
    }

    .grid-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .grid-2{grid-template-columns:1fr} }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin-top:4px;
    }

    .alert{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid;
      display:none;
      font-size:14px;
      line-height:1.35;
    }
    .alert.ok{
      display:block;
      background: rgba(27,127,75,.08);
      border-color: rgba(27,127,75,.25);
      color: var(--ok);
    }
    .alert.err{
      display:block;
      background: rgba(198,40,40,.08);
      border-color: rgba(198,40,40,.25);
      color: var(--danger);
    }

    .rules{
      padding:18px;
      border-top:1px dashed var(--border);
      background: linear-gradient(180deg, rgba(0,58,143,.03), transparent);
    }
    .rules h3{margin:0 0 8px; font-size:16px}
    .rules ul{margin:0; padding-left:18px; color:var(--text)}
    .rules li{margin:8px 0; color:var(--muted); line-height:1.45}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(11,18,32,.55);
      display:none;
      padding:16px;
      z-index:50;
    }
    .modal{
      max-width:720px;
      margin: 40px auto;
      background:#fff;
      border-radius:18px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.2);
    }
    .modal-head{
      padding:14px 16px;
      background: linear-gradient(90deg, var(--rexel-blue), var(--rexel-blue-2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal-head h3{margin:0; font-size:15px}
    .modal-body{padding:16px}
    .close{
      background: rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }
    .modal-backdrop.show{display:block}

    .footer{
      max-width:980px;
      margin:0 auto;
      padding:0 16px 30px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-bottom-width:2px;
      border-radius:8px;
      background:#fff;
      color:var(--text);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="pill">Rexel-bl√•tt tema</div>
        <h1>Daniel vs Dalarna ‚Äì tidstips</h1>
      </div>
      <button class="btn btn-ghost" id="openRulesBtn" type="button">üìú Regler</button>
<button class="btn btn-ghost" id="openAdminBtn" type="button" style="display:none;">üîí Admin</button>
    </div>
  </div>

  <main class="container">
    <!-- LEFT: Hero -->
    <section class="card">
      <div class="card-header">
        <div class="icon" aria-hidden="true" title="Vasalopps-ikon (Daniel edition)">
          <svg width="34" height="34" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 52c8 6 36 6 44 0" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M18 44l12-18 8 6 12-10" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="30" cy="18" r="6" stroke="rgba(0,58,143,.9)" stroke-width="4"/>
            <path d="M28 24l-8 14" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
            <path d="M34 26l8 10" stroke="rgba(0,58,143,.9)" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="titleblock">
          <h2 id="heroTitle">‚õ∑Ô∏è Hur l√§nge orkar Daniel?</h2>
          <p>
            Daniel har laddat med bl√•b√§rssoppa, tejpade stavar och ett sj√§lvf√∂rtroende som pendlar mellan
            ‚Äújag √§r od√∂dlig‚Äù och ‚Äúvarf√∂r finns uppf√∂rsbackar‚Äù. Hur l√§nge orkar en k√∂ttbulle p√• skidor igentligen? 
            <br><br>
            Din uppgift: gissa <b>hur l√§nge</b> han h√•ller ut.
          </p>

          <div class="cta-row">
            <button class="btn btn-accent" id="scrollToFormBtn" type="button">üéØ Gissa tid</button>
            <button class="btn btn-primary" id="shareBtn" type="button">üì≤ Dela</button>
          </div>

          <p class="hint">
            Tips: skriv tiden som <span class="kbd">HH:MM:SS</span> (t.ex. <span class="kbd">07:12:00</span>).
            Gratis att delta. 1 gissning per person.
          </p>
        </div>
      </div>

      <div class="rules">
        <h3>Snabbregler</h3>
        <ul>
          <li><b>Gratis</b>. Du gissar en g√•ng.</li>
          <li>Vinnare = den som √§r <b>n√§rmast</b> Daniels officiella tid.</li>
          <li>Om Daniel bryter eller som det heter g√•r in i v√§ggen: vi anv√§nder tiden vid <b>sista officiella kontroll</b>.</li>
        </ul>
      </div>
    </section>

    <!-- RIGHT: Form -->
    <section class="card" id="guessCard">
      <div class="card-header">
        <div class="titleblock">
          <h2>üßæ L√§gg din gissning</h2>
          <p>Fyll i namn, mobilnummer och din gissade tid. Du kan bara skicka in en g√•ng p√• den h√§r enheten.</p>
        </div>
      </div>

      <div class="card-body">

  <div id="gameStatusBox" style="border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;">
    <div style="font-weight:900;">‚è≥ Status</div>
    <div id="gameStatusText" style="margin-top:6px; font-weight:800;">Laddar tider‚Ä¶</div>
    <div class="hint" id="gameStatusHint" style="margin-top:6px;"></div>
  </div>

  <form class="form" id="guessForm" autocomplete="on" novalidate>

          <div class="grid-2">
            <div>
              <label for="name">Namn</label>
              <input id="name" name="name" type="text" placeholder="F√∂rnamn Efternamn" required />
            </div>
            <div>
              <label for="phone">Mobilnummer</label>
              <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="07XXXXXXXX" required />
              <div class="hint">Anv√§nds bara f√∂r att kontakta vinnaren och hindra fler gissningar (p√• denna enhet).</div>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="timeGuess">Gissad tid (HH:MM:SS)</label>
              <input id="timeGuess" name="timeGuess" type="text" inputmode="numeric" placeholder="07:12:00" required />
              <div class="hint">Du kan skriva eller klistra in. Vi validerar formatet.</div>
            </div>
            <div>
              <label for="consent">Godk√§nnande</label>
              <div style="display:flex; align-items:flex-start; gap:10px; margin-top:8px;">
                <input id="consent" name="consent" type="checkbox" style="width:auto; transform: scale(1.2);" required />
                <span style="font-size:14px; color:var(--muted); line-height:1.35;">
                  Jag godk√§nner reglerna och att vi sparar mina uppgifter f√∂r att kunna kontakta vinnaren.
                </span>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" type="submit" id="submitBtn">‚úÖ Skicka min gissning</button>

          <div class="alert ok" id="okAlert"></div>
          <div class="alert err" id="errAlert"></div>

          <div class="hint" style="margin-top:10px;">
            Admin/MVP: just nu sparas gissningen lokalt i din webbl√§sare. Vill ni samla alla gissningar centralt kan vi koppla
            till Google Sheets eller en liten backend senare.
          </div>
        </form>
      </div>
    </section>

    <!-- ADMIN PANEL (hidden) -->
    <section class="card" id="adminCard" style="display:none;">
      <div class="card-header">
        <div class="titleblock">
          <h2>üîí Admin</h2>
          <p>Mata in Daniels officiella tid (eller sista checkpoint-tid). Sidan r√§knar vinnaren.</p>
        </div>
      </div>

      <div class="card-body">
        <div class="form" style="margin-top:0;">
          <div class="grid-2">
            <div>
              <label for="danielTime">Daniels tid (HH:MM:SS)</label>
              <input id="danielTime" type="text" inputmode="numeric" placeholder="07:18:42" />
              <div class="hint">Anv√§nd exakt format HH:MM:SS.</div>
            </div>
            <div>
              <label for="adminNote">Notering (valfritt)</label>
              <input id="adminNote" type="text" placeholder="M√•l / br√∂t vid kontroll X" />
            </div>
          </div>

          <div class="cta-row" style="margin-top:8px;">
            <button class="btn btn-primary" type="button" id="calcWinnerBtn">üèÜ R√§kna vinnare</button>
            <button class="btn btn-ghost" type="button" id="exportBtn">‚¨áÔ∏è Exportera gissningar (CSV)</button>
            <button class="btn btn-ghost" type="button" id="clearLocalBtn">üßπ Nollst√§ll (denna enhet)</button>
          </div>

          <div class="alert ok" id="adminOk" style="display:none;"></div>
          <div class="alert err" id="adminErr" style="display:none;"></div>

          <div class="card" style="margin-top:12px; border-radius:14px;">
            <div class="card-body" style="padding:14px;">
              <div style="font-weight:800; margin-bottom:6px;">Resultat</div>
              <div id="winnerBox" style="color:var(--muted); line-height:1.5;">
                Inget utr√§knat √§nnu.
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Admin-l√§ge √∂ppnas genom att klicka 5 g√•nger p√• rubriken ‚ÄúHur l√§nge orkar Daniel?‚Äù.
          </div>
        </div>
      </div>
    </section>
<!-- LIVE DASHBOARD -->
      <h2>üìä Nuvarande st√§llning</h2>
      <p>
        Topp 10 just nu. Klicka <b>Ut√∂ka</b> f√∂r att se alla deltagare.
      </p>
      <p class="hint" id="liveMeta">Laddar‚Ä¶</p>
      <div class="cta-row" style="margin-top:10px;">
        <button class="btn btn-primary" type="button" id="refreshLiveBtn">üîÑ Uppdatera</button>
        <button class="btn btn-ghost" type="button" id="toggleAllBtn">‚ûï Ut√∂ka</button>
      </div>
    </div>
  </div>

  <div class="card-body">
    <div id="top10Box" style="display:grid; gap:10px;"></div>
    <div id="allBox" style="display:none; margin-top:14px;"></div>
  </div>
</section>
<!-- LIVE DASHBOARD -->
<section class="card" id="liveCard">
  <div class="card-header">
    <div class="titleblock">
      

  </main>

  <div class="footer">
    <div><b>Integritet:</b> Vi sparar namn och telefonnummer lokalt f√∂r att kunna kontakta vinnaren och administrera t√§vlingen. Raderas efter avslutad t√§vling.</div>
  </div>

  <!-- Rules Modal -->
  <div class="modal-backdrop" id="rulesModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <div class="modal-head">
        <h3 id="rulesTitle">üìú Spelregler ‚Äì ‚ÄúHur l√§nge orkar Daniel?‚Äù</h3>
        <button class="close" id="closeRulesBtn" type="button">St√§ng ‚úï</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0;color:var(--muted);line-height:1.6">
          Enkelt, tydligt och utan kr√•ngel.
        </p>

        <h4 style="margin:16px 0 8px;">1) S√• h√§r g√∂r du</h4>
        <ol style="margin:0; padding-left:18px; color:var(--muted); line-height:1.6">
          <li>Gissa Daniels tid i <b>HH:MM:SS</b>.</li>
          <li>Fyll i namn + telefonnummer.</li>
          <li>Skicka in ‚Äì klart.</li>
        </ol>

        <h4 style="margin:16px 0 8px;">2) En gissning</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Gratis att delta. Du f√•r l√§mna <b>en (1)</b> gissning per mobilnummer p√• den h√§r enheten.
        </p>

        <h4 style="margin:16px 0 8px;">3) Hur r√§knas tiden?</h4>
        <ul style="margin:0; padding-left:18px; color:var(--muted); line-height:1.6">
          <li>G√•r Daniel i m√•l ‚Üí <b>officiell m√•ltid</b> g√§ller.</li>
          <li>Bryter Daniel ‚Üí <b>tiden vid sista officiella kontrollen</b> g√§ller.</li>
          <li>Vi anv√§nder arrang√∂rens officiella tider/resultat.</li>
        </ul>

        <h4 style="margin:16px 0 8px;">4) Vinnare</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Den som gissar <b>n√§rmast</b> vinner priset. Vid exakt lika: f√∂rst inskickad gissning vinner.
        </p>

        <h4 style="margin:16px 0 8px;">5) Personuppgifter</h4>
        <p style="margin:0;color:var(--muted);line-height:1.6">
          Namn och telefon anv√§nds bara f√∂r att administrera t√§vlingen och kontakta vinnaren. Vi sparar detta lokalt i webbl√§saren i denna MVP.
        </p>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    const $ = (id) => document.getElementById(id);

    function normalizePhone(phoneRaw){
      return (phoneRaw || "").replace(/\s+/g, "").replace(/-/g, "");
    }

    function parseHHMMSS(s){
      const m = /^(\d{1,2}):([0-5]\d):([0-5]\d)$/.exec((s||"").trim());
      if(!m) return null;
      const h = Number(m[1]), mm = Number(m[2]), ss = Number(m[3]);
      if(h > 30) return null; // sanity limit
      return h*3600 + mm*60 + ss;
    }

    function formatHHMMSS(seconds){
      const h = Math.floor(seconds/3600);
      const m = Math.floor((seconds%3600)/60);
      const s = seconds%60;
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    // --- UI actions ---
    const rulesModal = $("rulesModal");
    $("openRulesBtn").addEventListener("click", ()=> rulesModal.classList.add("show"));
    $("closeRulesBtn").addEventListener("click", ()=> rulesModal.classList.remove("show"));
    rulesModal.addEventListener("click", (e)=>{ if(e.target === rulesModal) rulesModal.classList.remove("show"); });

    $("scrollToFormBtn").addEventListener("click", ()=>{
      $("guessCard").scrollIntoView({behavior:"smooth", block:"start"});
      setTimeout(()=> $("timeGuess").focus(), 400);
    });

    $("shareBtn").addEventListener("click", async ()=>{
      const text = "‚õ∑Ô∏è Hur l√§nge orkar Daniel? Gissa tiden (gratis) ‚Äì n√§rmast vinner pris!";
      try{
        if(navigator.share){
          await navigator.share({ title: document.title, text, url: location.href });
        }else{
          await navigator.clipboard.writeText(location.href);
          alert("L√§nken kopierad!");
        }
      }catch(_){}
    });

    // --- Submission logic (localStorage MVP) ---
    const STORAGE_KEY = "daniel-vasaloppet-guesses-v1";

    function loadAllGuesses(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch(_){ return []; }
    }
    function saveAllGuesses(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    function phoneAlreadyUsed(phone){
      const all = loadAllGuesses();
      return all.some(g => g.phone === phone);
    }

    function showOk(msg){
      $("okAlert").textContent = msg;
      $("errAlert").textContent = "";
      $("errAlert").style.display = "none";
      $("okAlert").style.display = "block";
    }
    function showErr(msg){
      $("errAlert").textContent = msg;
      $("okAlert").textContent = "";
      $("okAlert").style.display = "none";
      $("errAlert").style.display = "block";
    }

    function lockForm(){
      ["name","phone","timeGuess","consent"].forEach(id => $(id).disabled = true);
      $("submitBtn").disabled = true;
      $("submitBtn").textContent = "üîí Gissning inskickad";
    }

    $("guessForm").addEventListener("submit", (e)=>{
      e.preventDefault();

      const name = ($("name").value || "").trim();
      const phone = normalizePhone($("phone").value);
      const timeStr = ($("timeGuess").value || "").trim();
      const consent = $("consent").checked;

      if(!name) return showErr("Skriv ditt namn.");
      if(!phone || phone.length < 9) return showErr("Skriv ett giltigt mobilnummer.");
      if(!consent) return showErr("Du m√•ste godk√§nna reglerna f√∂r att delta.");

      const seconds = parseHHMMSS(timeStr);
      if(seconds === null) return showErr("Tiden m√•ste vara i formatet HH:MM:SS (t.ex. 07:12:00).");

      if(phoneAlreadyUsed(phone)){
        return showErr("Det h√§r mobilnumret har redan l√§mnat en gissning p√• den h√§r enheten.");
      }

      const all = loadAllGuesses();
      const entry = {
  name,
  phone,
  guess_seconds: seconds,
  guess_time: formatHHMMSS(seconds),
  created_at: new Date().toISOString()
};

// Skicka till Google Sheets
fetch(LIVE_ENDPOINT, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(entry)
})
.then(res => res.json())
.then(data => {
  if(!data.ok) throw new Error("Kunde inte spara gissningen.");

  showOk(`Klart! ‚úÖ Din gissning √§r skickad: ${entry.guess_time}. Nu √•terst√•r bara att Daniel‚Ä¶ st√•r ut. üòÖ`);
  lockForm();
  updateDashboard(); // uppdatera listan direkt
})
.catch(err => {
  showErr("Kunde inte skicka gissningen. F√∂rs√∂k igen.");
});

  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(entry)
})
.then(res => res.json())
.then(data => {
  if(!data.ok) throw new Error("Kunde inte spara gissningen.");

  showOk(`Klart! ‚úÖ Din gissning √§r skickad: ${entry.guess_time}. Nu √•terst√•r bara att Daniel‚Ä¶ st√•r ut. üòÖ`);
  lockForm();
})
.catch(err => {
  showErr("Kunde inte skicka gissningen. F√∂rs√∂k igen.");
});


    // --- ADMIN (hidden) ---
    (function adminSetup(){
      const adminCard = $("adminCard");
      const adminOk = $("adminOk");
      const adminErr = $("adminErr");
      const winnerBox = $("winnerBox");

      function ok(msg){
        if(adminOk){ adminOk.textContent = msg; adminOk.style.display="block"; }
        if(adminErr){ adminErr.style.display="none"; }
      }
      function err(msg){
        if(adminErr){ adminErr.textContent = msg; adminErr.style.display="block"; }
        if(adminOk){ adminOk.style.display="none"; }
      }

      // 5 clicks on hero title
      let clicks = 0;
      let t = null;
      const heroTitle = $("heroTitle");
      if(heroTitle){
        heroTitle.style.cursor = "pointer";
        heroTitle.addEventListener("click", ()=>{
          clicks++;
          clearTimeout(t);
          t = setTimeout(()=> clicks = 0, 1200);
          if(clicks >= 5){
            adminCard.style.display = "block";
            adminCard.scrollIntoView({behavior:"smooth", block:"start"});
            clicks = 0;
            ok("Admin-l√§ge √∂ppnat.");
          }
        });
      }

      function maskPhone(p){
        const ph = normalizePhone(p);
        if(ph.length <= 4) return ph;
        return ph.slice(0,3) + "****" + ph.slice(-2);
      }

      function calcWinner(){
        const danielStr = ($("danielTime").value || "").trim();
        const note = ($("adminNote").value || "").trim();
        const danielSec = parseHHMMSS(danielStr);
        if(danielSec === null) return err("Daniels tid m√•ste vara HH:MM:SS (t.ex. 07:18:42).");

        const all = loadAllGuesses();
        if(!all.length) return err("Inga gissningar sparade p√• den h√§r enheten.");

        let best = null;
        for(const g of all){
          const guessSec = g.guess_seconds ?? parseHHMMSS(g.guess_time);
          if(typeof guessSec !== "number") continue;
          const diff = guessSec - danielSec;
          const abs = Math.abs(diff);
          const created = Date.parse(g.created_at || "") || Number.MAX_SAFE_INTEGER;

          const entry = {...g, guessSec, diff, abs, created};
          if(!best) best = entry;
          else if(entry.abs < best.abs) best = entry;
          else if(entry.abs === best.abs && entry.created < best.created) best = entry;
        }
        if(!best) return err("Kunde inte r√§kna (saknar giltiga gissningar).");

        const sign = best.diff < 0 ? "-" : "+";
        const d = Math.abs(best.diff);
        const mm = Math.floor((d%3600)/60);
        const ss = d%60;
        const pad = (n)=> String(n).padStart(2,"0");

        winnerBox.innerHTML = `
          <div><b>Daniels tid:</b> ${formatHHMMSS(danielSec)} ${note ? `<span style="color:var(--muted)">(${note})</span>` : ""}</div>
          <div style="margin-top:8px;"><b>Vinnare:</b> ${best.name || "Ok√§nd"} (${maskPhone(best.phone)})</div>
          <div><b>Gissning:</b> ${best.guess_time || formatHHMMSS(best.guessSec)}</div>
          <div><b>Avvikelse:</b> ${sign}${pad(mm)}:${pad(ss)} (${best.abs} sek)</div>
        `;
        ok("Vinnare utr√§knad ‚úÖ");
      }

      function exportCSV(){
        const all = loadAllGuesses();
        if(!all.length) return err("Inga gissningar att exportera p√• den h√§r enheten.");

        const header = ["name","phone","guess_time","guess_seconds","created_at"];
        const rows = [header.join(",")];
        for(const g of all){
          const row = [
            (g.name||"").replaceAll('"','""'),
            (g.phone||"").replaceAll('"','""'),
            (g.guess_time||"").replaceAll('"','""'),
            String(g.guess_seconds ?? ""),
            (g.created_at||"").replaceAll('"','""')
          ].map(v => `"${v}"`);
          rows.push(row.join(","));
        }

        const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "gissningar.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        ok("CSV exporterat ‚úÖ");
      }

      function clearLocal(){
        if(!confirm("Nollst√§lla gissningar p√• den h√§r enheten?")) return;
        localStorage.removeItem(STORAGE_KEY);
        winnerBox.textContent = "Inget utr√§knat √§nnu.";
        ok("Nollst√§llt ‚úÖ");
      }

      $("calcWinnerBtn")?.addEventListener("click", calcWinner);
      $("exportBtn")?.addEventListener("click", exportCSV);
      $("clearLocalBtn")?.addEventListener("click", clearLocal);
    })();
    // ===== LIVE DASHBOARD =====

// 1) H√§r ska vi senare stoppa in din Google Sheets endpoint (Apps Script Web App).
// Just nu l√§mnar jag placeholder:
const LIVE_ENDPOINT = "https://script.google.com/macros/s/AKfycbxL30c5qw0KL_4QyNkyyjoN2lhZlonT0kHJ0oIX7a_UxstK0-osjvHOQsSpD0dOpb2r/exec";


let showAll = false;

function fmtDiff(absSeconds){
  const m = Math.floor(absSeconds/60);
  const s = absSeconds%60;
  const pad = (n)=> String(n).padStart(2,"0");
  if(m >= 60){
    const h = Math.floor(m/60);
    const mm = m%60;
    return `${pad(h)}:${pad(mm)}:${pad(s)}`;
  }
  return `${pad(m)}:${pad(s)}`;
}

function renderRows(rows, targetEl, limit=null){
  const list = (limit ? rows.slice(0, limit) : rows);

  if(list.length === 0){
    targetEl.innerHTML = `<div class="hint">Inga gissningar √§n.</div>`;
    return;
  }

  targetEl.innerHTML = list.map((r, idx)=>`
    <div style="border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; justify-content:space-between; gap:10px;">
      <div>
        <div style="font-weight:800;">#${idx+1} ${r.name}</div>
        <div class="hint">Gissning: <b>${r.guess_time}</b></div>
      </div>
      <div style="text-align:right;">
        <div style="font-weight:900;">${fmtDiff(r.absDiff)} </div>
        <div class="hint">${r.absDiff} sek</div>
      </div>
    </div>
  `).join("");
}

async function fetchLiveData(){
  // Om endpoint inte finns √§n, fall back: lokalt (f√∂r test)
  if(!LIVE_ENDPOINT){
    const all = loadAllGuesses();
    return {
      status: "local",
      official_time: null,
      guesses: all
    };
  }

  const res = await fetch(LIVE_ENDPOINT, { cache: "no-store" });
  if(!res.ok) throw new Error("Kunde inte h√§mta live-data");
  return await res.json();
}

async function updateDashboard(){
  const meta = document.getElementById("liveMeta");
  const top10Box = document.getElementById("top10Box");
  const allBox = document.getElementById("allBox");

  try{
    meta.textContent = "Laddar‚Ä¶";
    const data = await fetchLiveData();

    const officialStr = data.official_time; // "HH:MM:SS" eller null
    const officialSec = officialStr ? parseHHMMSS(officialStr) : null;

    // Om vi inte har officiell tid √§nnu -> visar ‚Äúinv√§ntar‚Äù
    if(officialSec === null){
      meta.innerHTML = `Officiell tid: <b>inte satt √§nnu</b> (admin kan s√§tta n√§r t√§vlingen startat).`;
      // Visa √§nd√• lista sorterad p√• gissad tid (valfritt)
      const rows = (data.guesses || []).map(g => ({
        name: g.name,
        guess_time: g.guess_time || formatHHMMSS(g.guess_seconds),
        absDiff: 0
      }));
      renderRows(rows, top10Box, 10);
      allBox.style.display = showAll ? "block" : "none";
      if(showAll) renderRows(rows, allBox, null);
      return;
    }

    // Bygg ranking: minsta absoluta diff mot officialSec
    const guesses = data.guesses || [];
    const ranked = guesses.map(g=>{
      const guessSec = g.guess_seconds ?? parseHHMMSS(g.guess_time);
      const diff = Math.abs(guessSec - officialSec);
      return {
        name: g.name,
        guess_time: g.guess_time || formatHHMMSS(guessSec),
        absDiff: diff,
        created_at: g.created_at || ""
      };
    }).sort((a,b)=>{
      if(a.absDiff !== b.absDiff) return a.absDiff - b.absDiff;
      // tiebreak: tidigast inskickad
      return (Date.parse(a.created_at)||0) - (Date.parse(b.created_at)||0);
    });

    meta.innerHTML = `Officiell tid just nu: <b>${officialStr}</b> ‚Ä¢ Deltagare: <b>${ranked.length}</b>`;
    renderRows(ranked, top10Box, 10);

    allBox.style.display = showAll ? "block" : "none";
    if(showAll){
      renderRows(ranked, allBox, null);
    }
  }catch(e){
    meta.textContent = "Kunde inte ladda st√§llningen. (Saknar endpoint eller n√§tfel.)";
    top10Box.innerHTML = `<div class="hint">${String(e.message || e)}</div>`;
  }
}

document.getElementById("refreshLiveBtn")?.addEventListener("click", updateDashboard);
document.getElementById("toggleAllBtn")?.addEventListener("click", ()=>{
  showAll = !showAll;
  document.getElementById("toggleAllBtn").textContent = showAll ? "‚ûñ Minimera" : "‚ûï Ut√∂ka";
  updateDashboard();
});

// K√∂r direkt vid sidladdning
updateDashboard();
// ===== LIVE DASHBOARD =====

// 1) H√§r ska vi senare stoppa in din Google Sheets endpoint (Apps Script Web App).
// Just nu l√§mnar jag placeholder:

let showAll = false;

function fmtDiff(absSeconds){
  const m = Math.floor(absSeconds/60);
  const s = absSeconds%60;
  const pad = (n)=> String(n).padStart(2,"0");
  if(m >= 60){
    const h = Math.floor(m/60);
    const mm = m%60;
    return `${pad(h)}:${pad(mm)}:${pad(s)}`;
  }
  return `${pad(m)}:${pad(s)}`;
}

function renderRows(rows, targetEl, limit=null){
  const list = (limit ? rows.slice(0, limit) : rows);

  if(list.length === 0){
    targetEl.innerHTML = `<div class="hint">Inga gissningar √§n.</div>`;
    return;
  }

  targetEl.innerHTML = list.map((r, idx)=>`
    <div style="border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; justify-content:space-between; gap:10px;">
      <div>
        <div style="font-weight:800;">#${idx+1} ${r.name}</div>
        <div class="hint">Gissning: <b>${r.guess_time}</b></div>
      </div>
      <div style="text-align:right;">
        <div style="font-weight:900;">${fmtDiff(r.absDiff)} </div>
        <div class="hint">${r.absDiff} sek</div>
      </div>
    </div>
  `).join("");
}

async function fetchLiveData(){
  // Om endpoint inte finns √§n, fall back: lokalt (f√∂r test)
  if(!LIVE_ENDPOINT){
    const all = loadAllGuesses();
    return {
      status: "local",
      official_time: null,
      guesses: all
    };
  }

  const res = await fetch(LIVE_ENDPOINT, { cache: "no-store" });
  if(!res.ok) throw new Error("Kunde inte h√§mta live-data");
  return await res.json();
}

async function updateDashboard(){
  const meta = document.getElementById("liveMeta");
  const top10Box = document.getElementById("top10Box");
  const allBox = document.getElementById("allBox");

  try{
    meta.textContent = "Laddar‚Ä¶";
    const data = await fetchLiveData();

    const officialStr = data.official_time; // "HH:MM:SS" eller null
    const officialSec = officialStr ? parseHHMMSS(officialStr) : null;

    // Om vi inte har officiell tid √§nnu -> visar ‚Äúinv√§ntar‚Äù
    if(officialSec === null){
      meta.innerHTML = `Officiell tid: <b>inte satt √§nnu</b> (admin kan s√§tta n√§r t√§vlingen startat).`;
      // Visa √§nd√• lista sorterad p√• gissad tid (valfritt)
      const rows = (data.guesses || []).map(g => ({
        name: g.name,
        guess_time: g.guess_time || formatHHMMSS(g.guess_seconds),
        absDiff: 0
      }));
      renderRows(rows, top10Box, 10);
      allBox.style.display = showAll ? "block" : "none";
      if(showAll) renderRows(rows, allBox, null);
      return;
    }

    // Bygg ranking: minsta absoluta diff mot officialSec
    const guesses = data.guesses || [];
    const ranked = guesses.map(g=>{
      const guessSec = g.guess_seconds ?? parseHHMMSS(g.guess_time);
      const diff = Math.abs(guessSec - officialSec);
      return {
        name: g.name,
        guess_time: g.guess_time || formatHHMMSS(guessSec),
        absDiff: diff,
        created_at: g.created_at || ""
      };
    }).sort((a,b)=>{
      if(a.absDiff !== b.absDiff) return a.absDiff - b.absDiff;
      // tiebreak: tidigast inskickad
      return (Date.parse(a.created_at)||0) - (Date.parse(b.created_at)||0);
    });

    meta.innerHTML = `Officiell tid just nu: <b>${officialStr}</b> ‚Ä¢ Deltagare: <b>${ranked.length}</b>`;
    renderRows(ranked, top10Box, 10);

    allBox.style.display = showAll ? "block" : "none";
    if(showAll){
      renderRows(ranked, allBox, null);
    }
  }catch(e){
    meta.textContent = "Kunde inte ladda st√§llningen. (Saknar endpoint eller n√§tfel.)";
    top10Box.innerHTML = `<div class="hint">${String(e.message || e)}</div>`;
  }
}

document.getElementById("refreshLiveBtn")?.addEventListener("click", updateDashboard);
document.getElementById("toggleAllBtn")?.addEventListener("click", ()=>{
  showAll = !showAll;
  document.getElementById("toggleAllBtn").textContent = showAll ? "‚ûñ Minimera" : "‚ûï Ut√∂ka";
  updateDashboard();
});

// K√∂r direkt vid sidladdning
updateDashboard();
// ===== TID / NEDR√ÑKNING / BETTINGSTOPP =====
let phaseInterval = null;

function parseStartDateTime(str){
  if(!str) return null;
  const s = String(str).trim().replace(" ", "T");
  const d = new Date(s);
  if(Number.isNaN(d.getTime())) return null;
  return d;
}

function formatClock(sec){
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  const pad = (n)=> String(n).padStart(2,"0");
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function lockBetting(msg){
  // L√•s formul√§r
  ["name","phone","timeGuess","consent"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.disabled = true;
  });
  const btn = document.getElementById("submitBtn");
  if(btn){
    btn.disabled = true;
    btn.textContent = "‚õî Betting st√§ngd";
  }
  const err = document.getElementById("errAlert");
  const ok = document.getElementById("okAlert");
  if(err){ err.style.display="none"; }
  if(ok){ ok.style.display="none"; }

  // Text
  const t = document.getElementById("gameStatusText");
  const h = document.getElementById("gameStatusHint");
  if(t) t.textContent = msg || "Betting √§r st√§ngd.";
  if(h) h.textContent = "";
}

function unlockBetting(){
  ["name","phone","timeGuess","consent"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.disabled = false;
  });
  const btn = document.getElementById("submitBtn");
  if(btn){
    btn.disabled = false;
    btn.textContent = "‚úÖ Skicka min gissning";
  }
}

function setStatus(text, hint){
  const t = document.getElementById("gameStatusText");
  const h = document.getElementById("gameStatusHint");
  if(t) t.textContent = text;
  if(h) h.textContent = hint || "";
}

function startPhaseClock({startDate, closeDate, official_time}){
  if(phaseInterval) clearInterval(phaseInterval);

  const tick = ()=>{
    const now = new Date();

    // Slutresultatl√§ge
    if(official_time){
      setStatus("üèÅ Loppet √§r avgjort (officiell tid satt).", "Leaderboard visar slutst√§llning.");
      // Betting ska vara st√§ngd
      lockBetting("üèÅ Betting st√§ngd ‚Äì loppet √§r avgjort.");
      return;
    }

    // Om ingen starttid: bara till√•t betting
    if(!startDate){
      setStatus("üü¢ √ñppet f√∂r gissningar", "Starttid √§r inte satt √§nnu.");
      unlockBetting();
      return;
    }

    // Om bettingstopp saknas: anta att betting √§r √∂ppen fram till start
    const effectiveClose = closeDate || startDate;

    if(now < effectiveClose){
      // F√∂re bettingstopp
      const secLeft = Math.max(0, Math.floor((effectiveClose - now)/1000));
      setStatus("üü¢ Betting √∂ppen", `Betting st√§nger om ${formatClock(secLeft)} (HH:MM:SS).`);
      unlockBetting();
      return;
    }

    if(now >= effectiveClose && now < startDate){
      // Efter bettingstopp men f√∂re start
      const secToStart = Math.max(0, Math.floor((startDate - now)/1000));
      lockBetting("‚õî Betting st√§ngd");
      setStatus("‚õî Betting st√§ngd", `Start om ${formatClock(secToStart)} (HH:MM:SS).`);
      return;
    }

    // Startat (nu k√∂r vi ‚Äúspelet‚Äù)
    const elapsed = Math.max(0, Math.floor((now - startDate)/1000));
    lockBetting("üöÄ Spelet har startat");
    setStatus("üöÄ Spelet p√•g√•r", `Daniel har (minst) h√•llit p√• i ${formatClock(elapsed)}.`);
  };

  tick();
  phaseInterval = setInterval(tick, 1000);
}
// ===== ADMIN TOGGLE (knapp + hemlig l√§nk) =====
(function(){
  const adminBtn = document.getElementById("openAdminBtn");
  const adminCard = document.getElementById("adminCard");
  if(!adminBtn || !adminCard) return;

  // Visa Admin-knappen om du har ?admin=1 i URL:en
  const params = new URLSearchParams(location.search);
  const isAdmin = params.get("admin") === "1";
  if(isAdmin){
    adminBtn.style.display = "inline-flex";
  }

  adminBtn.addEventListener("click", ()=>{
    const hidden = (adminCard.style.display === "none" || !adminCard.style.display);
    adminCard.style.display = hidden ? "block" : "none";
    if(hidden) adminCard.scrollIntoView({behavior:"smooth", block:"start"});
  });
})();

  </script>
</body>
</html>
